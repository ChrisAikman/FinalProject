<HTML>

<HEAD>
	<meta charset="utf-8">

	<!-- Framework scripts. -->
	<script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
	<script type="text/javascript" src="js/jquery.qtip.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/d3.min.js"></script>
	
	<!-- Vis scripts. -->
	<script type="text/javascript" src="js/constants.js"></script>
	<script type="text/javascript" src="js/helperfunctions.js"></script>
	<script type="text/javascript" src="js/datafunctions.js"></script>
	
	<!-- Style sheets. -->
	<link type="text/css" href="css/jquery.qtip.min.css" rel="stylesheet" />
	<link type="text/css" href="css/jquery-ui.min.css" rel="stylesheet" />
	<link type="text/css" href="css/style.css" rel="stylesheet" />
</HEAD>

<BODY>
<!-- Vis area. -->
<div id="root" style="margin: auto; width: 100%;" align="center">
	<!-- Control panel. -->
	<div id="controlpanel" style="float:left; width: 200px;">
		<div id="countrypanel" class="controlpanel">
			Selected Countries:
			<div id="countryHelp" class="helpbutton" style="float: right; margin-right: 2px;"><img src="css/images/help.png"/></div>
			<div id="countrylist" class="controlpanelinset" ></div>
		</div>
		<div id="viewpanel" class="controlpanel">
			Selected View:
			<div id="viewHelp" class="helpbutton" style="float: right; margin-right: 2px;"><img src="css/images/help.png"/></div>
			<div id="viewlist" class="controlpanelinset" ></div>
		</div>
		<div id="filterspanel" class="controlpanel">
			Selected Filters:
			<div id="filterHelp" class="helpbutton" style="float: right; margin-right: 2px;"><img src="css/images/help.png"/></div>
			<div id="filterlist" class="controlpanelinset" >
				<div class="controlpanelcountry" style="padding-left: 3px; padding-top: 3px;">
					<span id="yearsselected"></span>
					<div id="slider-year" style="margin:5px; margin-left: 8px; margin-right: 13px;"></div>
				</div>
				<div class="controlpanelcountry" style="padding-left: 3px; padding-top: 3px;">
					<span id="agesselected"></span>
					<div id="slider-age" style="margin:5px; margin-left: 8px; margin-right: 13px;"></div>
				</div>
				Genders:
			</div>
		</div>
		<div id="eventpanel" class="controlpanel">
			Selected Events:
			<div id="eventHelp" class="helpbutton" style="float: right; margin-right: 2px;"><img src="css/images/help.png"/></div>
			<div id="eventlist" class="controlpanelinset" ></div>
		</div>
	</div>
	
	<!-- Vis div. -->
	<div id="center-root" style="float:left;">
		<div id="vis"></div>
		<div id="overview"></div>
	</div>
	<div style="clear: both;" ></div>
</div>

<!-- Hover query div. -->
<div id="hoverquery" style="position: absolute; display: none;">
	<img width="20px" id="hqimg" src="#" /><strong id="countryname">Country</strong>
	<div style="padding-top: 2px;">
		<div id="year" style="float: left; padding-left: 5px; font-size: 1.8em;">
			YEAR
		</div>
		<div id="data" style="float: left; padding-left: 5px; text-align: left;">
			Data
		</div>
		<div style="clear: both;"></div>
	</div>
	<img class="callout" src="css/images/tooltippoint.png" />
</div>

<!-- Intro box fade background. -->
<div id="fadebox"></div>

<!-- Intro box for the vis. -->
<div id="introbox">
	<div id="title">
		<h1 style="font-family: Century Gothic, sans-serif;">EFFECTS OF HISTORIC EVENTS ON LIFE AND MORTALITY</h1>
		<h2 style="font-family: Century Gothic, sans-serif;">Based on Data from <a href="http://mortality.org">The Human Mortality Database</a></h2>
	</div>
	<img style="margin-top: 10px; margin-left: 15px; margin-right: 15px; float: right; border: 1px solid black; height: 117px;" src="css/images/VisThumb.png"></img>
	<p>
		Human mortality is a topic that has been of interest throughout history. Since the beginning of the scientific age, great efforts have been made to extend the average lifespan and reduce risk of death. A major contributing factor to changes in birth and death rates is historic events. Wars, diseases and scientific breakthroughs have all contributed to changes in population.  The goal of this project is to use past mortality and population data to make connections between lifespan, population growth and historical events.
	</p>
	<div id="introloading">LOADING...</div>
	<BR><BR>
	<div class="introhelp">Hover over the <img id="helpIcon" src="css/images/help.png"/> buttons to receive help at any time.</div>
	
</div>

<script type="text/javascript">
window.onresize = function( event ) {
	$("#vis").html( "" );
	$("#overview").html( "" );
	generateVis();
	fillVis();
}

var margin,	width, height, height2;

var leftOffset = 70;
var topOffset = 10;
var graph;
var overview;
var curdata;
var loadScriptOn = 0;
var maxy = 0;

function generateVis()
{
	// Set the dimensions of the canvas / graph
	var visheight = $( document ).height();
	var viswidth = $( window ).width() - 200;
	
	margin = {top: topOffset, right: 30, bottom: 30, left: leftOffset};
	width = viswidth - margin.left - margin.right - 9;
	height = visheight * .8 - margin.top - margin.bottom - 6;
	height2 = visheight * .2 - margin.top - margin.bottom - 9;
		
	graph = addGraph( "#vis", margin, width, height, [0, width], [height, 0], [0,0], [0, 0], 20, 20 );
	overview = addGraph( "#overview", margin, width, height2, [0,width], [height2, 0], [0,0], [0, 0], 20, 0 );
	addClip( graph, width, height );
	
	// Add the linking and brushing mechanism.
	var brush = d3.svg.brush()
		.x( overview["x"] )
		.on( "brush", brushed );
	
	overview["svg"].append( "g" )
      .attr( "class", "x brush" )
      .call( brush )
    .selectAll( "rect" )
      .attr( "y", -6 )
      .attr( "height", height2 + 7 );
		
	function brushed()
	{
		graph["x"].domain( brush.empty() ? overview["x"].domain() : brush.extent() );
		for( d in curdata["data"] )
			for( c in curdata["data"][d]["data"] )
				for( nd in curdata["data"][d]["data"][c]["data"] )
					graph["svg"].select( "." + c + curdata["data"][d]["name"] + nd ).attr( "d", graph[curdata["data"][d]["draw"]]( curdata["data"][d]["data"][c]["data"][nd], graph["x"] ) );
					
		for( e in curdata["events"] )
			graph["svg"].select( ".event" + curdata["events"][e]["num"] ).attr( "d", graph["valuearea"]( curdata["events"][e]["data"], graph["x"] ) );
		
		graph["svg"].select( ".x.axis" ).call( graph["xAxis"] );
	}
}

// Add the data based on filters.
function fillData( json, json2, json3, gender, name, type )
{
	var data = {};
	data["data"] = {};
	data["name"] = name;
	data["type"] = type;
	
	if( gender == GENDER_BOTH ) {
		data["draw"] = "valuearea";
		for( var c in json["data"] )
			data["data"][c] = areaCombine( json["data"][c], json2["data"][c], 0, 1 );
			
		json = json2 = 0;
	}
	else
		data["draw"] = "valueline";
		
	if( gender == GENDER_MALE )
		data["data"] = json["data"];
	if( gender == GENDER_FEMALE )
		data["data"] = json2["data"];
	if( gender == GENDER_TOTAL )
		data["data"] = json3["data"];
		
	curdata["data"].push( data );
}

function fillVis()
{
	graph["svg"].selectAll("path").remove();
	overview["svg"].selectAll("path").remove();

	var selectedCountries = $('#countrylist input:checkbox:checked').map(function() {
		return this.value;
	}).get();
	
	var view = $( "#viewlist input[type='radio']:checked" ).val();
	var gender = $( "#filterlist input[type='radio']:checked" ).val();
	var years = $( "#slider-year" ).slider( "option", "values" );

	curdata = { "data":[], "events":[] };
	
	var json, json2, json3;
	
	if( view == VIEW_BIRTHS || view == VIEW_BANDD ) {
		if( gender == GENDER_MALE || gender == GENDER_BOTH )
			json = genBirths( selectedCountries, years, GENDER_MALE );
		if( gender == GENDER_FEMALE || gender == GENDER_BOTH )
			json2 = genBirths( selectedCountries, years, GENDER_FEMALE );
		if( gender == GENDER_TOTAL )
			json3 = genBirths( selectedCountries, years, GENDER_TOTAL );
			
		fillData( json, json2, json3, gender, "birhts", "B" + genders[gender][1] );
	}
	
	if( view == VIEW_DEATHS || view == VIEW_BANDD ) {
		if( gender == GENDER_MALE || gender == GENDER_BOTH )
			json = genPopDeath( selectedCountries, years, GENDER_MALE, deaths );
		if( gender == GENDER_FEMALE || gender == GENDER_BOTH )
			json2 = genPopDeath( selectedCountries, years, GENDER_FEMALE, deaths );
		if( gender == GENDER_TOTAL )
			json3 = genPopDeath( selectedCountries, years, GENDER_TOTAL, deaths );
			
		fillData( json, json2, json3, gender, "deaths", "D" + genders[gender][1] );
	}
	
	if( view == VIEW_POPULATION || view == VIEW_BANDD ) {
		if( gender == GENDER_MALE || gender == GENDER_BOTH )
			json = genPopDeath( selectedCountries, years, GENDER_MALE, populations );
		if( gender == GENDER_FEMALE || gender == GENDER_BOTH )
			json2 = genPopDeath( selectedCountries, years, GENDER_FEMALE, populations );
		if( gender == GENDER_TOTAL )
			json3 = genPopDeath( selectedCountries, years, GENDER_TOTAL, populations );
			
		fillData( json, json2, json3, gender, "populations", "P" + genders[gender][1] );
	}
		
	// Update the axis.
	var xtent = [], ytent = [];
	for( var x in ["data"] )
		for( var y in curdata["data"][x]["data"] ) 
			for( var z in curdata["data"][x]["data"][y]["data"] ) {
				xtent.push( d3.extent( curdata["data"][x]["data"][y]["data"][z], function(d) { return d[0]; } ) );
				ytent.push( d3.extent( curdata["data"][x]["data"][y]["data"][z], function(d) { if( 2 in d ) return Math.max( d[1], d[2] ); else return d[1]; } ) );
			}
	
	// Get the new domains for the x and y axis and update their views.
	var minx = d3.min( xtent, function(d) { return d[0]; } );
	var maxx = d3.max( xtent, function(d) { return d[1]; } );
	maxy = d3.max( ytent, function(d) { return d[1]; } );
	
	graph["x"].domain( [ minx, maxx ] );
	graph["y"].domain( [ 0, maxy ] );
	
	overview["x"].domain( [ minx, maxx ] );
	overview["y"].domain( [ 0, maxy ] );
	
	graph["svg"].selectAll("g.x.axis").call( graph["xAxis"] );
	graph["svg"].selectAll("g.y.axis").call( graph["yAxis"] );
	overview["svg"].selectAll("g.x.axis").call( overview["xAxis"] );
	
	// Add events.
	addSelectedEvents( curdata, maxy );
		
	for( var d in curdata["data"] )
		addData( curdata["data"][d], graph, overview );
}

$(function () {
	introBox();
	addHelp();
});
</script>

</BODY>

</HTML>