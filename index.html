<HTML>

<HEAD>
	<meta charset="utf-8">

	<script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
	<script type="text/javascript" src="js/jquery.qtip.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/d3.min.js"></script>
	<script type="text/javascript" src="js/helperfunctions.js"></script>
	<script type="text/javascript" src="js/datafunctions.js"></script>
	
	<link type="text/css" href="css/jquery.qtip.min.css" rel="stylesheet" />
	<link type="text/css" href="css/jquery-ui.min.css" rel="stylesheet" />
	<link type="text/css" href="css/style.css" rel="stylesheet" />
</HEAD>

<BODY>
<div id="root" style="margin: auto; width: 100%;" align="center">
	<div id="controlpanel" style="float:left; width: 200px;">
		<div id="countrypanel" class="controlpanel">
			Selected Countries:
			<div id="countryHelp" class="helpbutton" style="float: right; margin-right: 2px;"><img src="css/images/help.png"/></div>
			<div id="countrylist" class="controlpanelinset" ></div>
		</div>
		<div id="viewpanel" class="controlpanel">
			Selected View:
			<div id="viewHelp" class="helpbutton" style="float: right; margin-right: 2px;"><img src="css/images/help.png"/></div>
			<div id="viewlist" class="controlpanelinset" ></div>
		</div>
		<div id="filterspanel" class="controlpanel">
			Selected Filters:
			<div id="filterHelp" class="helpbutton" style="float: right; margin-right: 2px;"><img src="css/images/help.png"/></div>
			<div id="filterlist" class="controlpanelinset" >
				<div class="controlpanelcountry" style="padding-left: 3px; padding-top: 3px;">
					<span id="yearsselected"></span>
					<div id="slider-year" style="margin:5px; margin-left: 8px; margin-right: 13px;"></div>
				</div>
				<div class="controlpanelcountry" style="padding-left: 3px; padding-top: 3px;">
					<span id="agesselected"></span>
					<div id="slider-age" style="margin:5px; margin-left: 8px; margin-right: 13px;"></div>
				</div>
				Genders:
			</div>
		</div>
		<div id="eventpanel" class="controlpanel">
			Selected Events:
			<div id="eventHelp" class="helpbutton" style="float: right; margin-right: 2px;"><img src="css/images/help.png"/></div>
			<div id="eventlist" class="controlpanelinset" ></div>
		</div>
	</div>
	<div id="center-root" style="float:left;">
		<div id="vis"></div>
		<div id="overview"></div>
	</div>
	<div style="clear: both;" ></div>
</div>
<div id="hoverquery" style="position: absolute; display: none;">
	<img width="20px" id="hqimg" src="#" /><strong id="countryname">Country</strong>
	<div style="padding-top: 2px;">
		<div id="year" style="float: left; padding-left: 5px; font-size: 1.8em;">
			YEAR
		</div>
		<div id="data" style="float: left; padding-left: 5px; text-align: left;">
			Data
		</div>
		<div style="clear: both;"></div>
	</div>
	<img class="callout" src="css/images/tooltippoint.png" />
</div>

<div id="fadebox"></div>

<!-- Intro box for the vis. -->
<div id="introbox">
	<div id="title">
		<h1 style="font-family: Century Gothic, sans-serif;">EFFECTS OF HISTORIC EVENTS ON LIFE AND MORTALITY</h1>
		<h2 style="font-family: Century Gothic, sans-serif;">Based on Data from <a href="http://mortality.org">The Human Mortality Database</a></h2>
	</div>
	<img style="margin-top: 10px; margin-left: 15px; margin-right: 15px; float: right; border: 1px solid black; width: 300px;" src="css/images/VisThumb.png"></img>
	<p>
		Human mortality is a topic that has been of interest throughout history. Since the beginning of the scientific age, great efforts have been made to extend the average lifespan and reduce risk of death. A major contributing factor to changes in birth and death rates is historic events. Wars, diseases and scientific breakthroughs have all contributed to changes in population.  The goal of this project is to use past mortality and population data to make connections between lifespan, population growth and historical events.
	</p>
	<div id="introloading">LOADING...</div>
	<BR><BR>
	<div class="introhelp">Hover over the <img id="helpIcon" src="css/images/help.png"/> buttons to receive help at any time.</div>
	
</div>

<script type="text/javascript">
window.onresize = function( event ) {
	$("#vis").html( "" );
	$("#overview").html( "" );
	generateVis();
	fillVis();
}

var margin,	width, height, height2;

var leftOffset = 70;
var topOffset = 10;
var graph;
var overview;
var curdata;
var loadScriptOn = 0;

function generateVis()
{
	// Set the dimensions of the canvas / graph
	var visheight = $( document ).height();
	var viswidth = $( window ).width() - 200;
	
	margin = {top: topOffset, right: 30, bottom: 30, left: leftOffset};
	width = viswidth - margin.left - margin.right - 9;
	height = visheight * .8 - margin.top - margin.bottom - 6;
	height2 = visheight * .2 - margin.top - margin.bottom - 9;
		
	graph = addGraph( "#vis", margin, width, height, [0, width], [height, 0], [1800,2020], [0, 2400000], 20, 20 );
	overview = addGraph( "#overview", margin, width, height2, [0,width], [height2, 0], [1800,2020], [0, 2400000], 20, 0 );
	addClip( graph, width, height );
	
	var brush = d3.svg.brush()
		.x( overview["x"] )
		.on( "brush", brushed );
	
	// Add the linking and brushing mechanism.
	overview["svg"].append("g")
      .attr("class", "x brush")
      .call(brush)
    .selectAll( "rect" )
      .attr( "y", -6 )
      .attr( "height", height2 + 7 );
		
	function brushed()
	{
		graph["x"].domain( brush.empty() ? overview["x"].domain() : brush.extent() );
		for( d in curdata )
			for( c in curdata[d]["data"] )
				graph["svg"].select( "." + c + curdata[d]["name"] ).attr( "d", graph[curdata[d]["draw"]]( curdata[d]["data"][c], graph["x"] ) );
		
		/*for( c in data["data"] ) {
			graph["svg"].select( "." + c + data["name"] ).attr( "d", graph["valuearea"]( data["data"][c], graph["x"] ) );
			graph["svg"].select( "." + c + data2["name"] ).attr( "d", graph["valuearea"]( data2["data"][c], graph["x"] ) );
		}*/
		graph["svg"].select( ".event" ).attr( "d", graph["valuearea"]( [ [ 1870, 0, 2400000 ], [ 1871, 0, 2400000 ] ], graph["x"] ) )
		graph["svg"].select( ".x.axis" ).call( graph["xAxis"] );
	}
}

function fillVis()
{
	graph["svg"].selectAll("path").remove();
	overview["svg"].selectAll("path").remove();

	var selectedCountries = $('#countrylist input:checkbox:checked').map(function() {
		return this.value;
	}).get();
	
	var view = $( "#viewlist input[type='radio']:checked" ).val();
	var years = $( "#slider-year" ).slider( "option", "values" );

	curdata = [];
	
	// Gather the data.
	if( view == VIEW_BIRTHS || view == VIEW_BANDD ) {
		var json = genBirths( selectedCountries, years, GENDER_MALE );
		var json2 = genBirths( selectedCountries, years, GENDER_FEMALE );
		
		var data = {};
		data["data"] = {};
		data["name"] = "births";
		data["type"] = "BB";
		data["draw"] = "valuearea";
		for( var c in json["data"] )
			data["data"][c] = areaCombine( json["data"][c], json2["data"][c], 0, 1 );
			
		json = json2 = 0;
			
		curdata.push( data );
	}
	
	if( view == VIEW_DEATHS || view == VIEW_BANDD ) {
		var json = genPopDeath( selectedCountries, years, GENDER_MALE, deaths );
		var json2 = genPopDeath( selectedCountries, years, GENDER_FEMALE, deaths );
		
		var data = {};
		data["data"] = {};
		data["name"] = "deaths";
		data["type"] = "DB";
		data["draw"] = "valuearea";
		for( var c in json["data"] )
			data["data"][c] = areaCombine( json["data"][c], json2["data"][c], 0, 1 );
			
		json = json2 = 0;
			
		curdata.push( data );
	}
	
	if( view == VIEW_POPULATION ) {
		var json = genPopDeath( selectedCountries, years, GENDER_MALE, populations );
		var json2 = genPopDeath( selectedCountries, years, GENDER_FEMALE, populations );
		
		var data = {};
		data["data"] = {};
		data["name"] = "deaths";
		data["type"] = "PB";
		data["draw"] = "valuearea";
		for( var c in json["data"] )
			data["data"][c] = areaCombine( json["data"][c], json2["data"][c], 0, 1 );
			
		json = json2 = 0;
			
		curdata.push( data );
	}
	
	/*curdata.push( {
		"data": [ [ 1870, 0, 2400000 ], [ 1871, 0, 2400000 ] ],
		"name": "France Something",
		"type": "XE",
		"draw": "valuearea"
	} );*/

	// Add the data
	graph["svg"].append("path")
		.attr( "class", "event" )
		.style( "fill", "gray" )
		.attr( "d", graph["valuearea"]( [ [ 1870, 0, 2400000 ], [ 1871, 0, 2400000 ] ], graph["x"] ) )
		.attr( "clip-path", "url(#clip)" );
		
	// Update the axis.
	var xtent = [], ytent = [];
	for( var x in curdata )
		for( var y in curdata[x]["data"] ) {
			xtent.push( d3.extent( curdata[x]["data"][y], function(d) { return d[0]; } ) );
			ytent.push( d3.extent( curdata[x]["data"][y], function(d) { if( 2 in d ) return Math.max( d[1], d[2] ); else return d[1]; } ) );
		}
	
	var minx = d3.min( xtent, function(d) { return d[0]; } );
	var maxx = d3.max( xtent, function(d) { return d[1]; } );
	var maxy = d3.max( ytent, function(d) { return d[1]; } );
	
	graph["x"].domain( [ minx, maxx ] );
	graph["y"].domain( [ 0, maxy ] );
	
	overview["x"].domain( [ minx, maxx ] );
	overview["y"].domain( [ 0, maxy ] );
	
	graph["svg"].selectAll("g.x.axis").call( graph["xAxis"] );
	graph["svg"].selectAll("g.y.axis").call( graph["yAxis"] );
	overview["svg"].selectAll("g.x.axis").call( overview["xAxis"] );
		
	for( var d in curdata )
		addData( curdata[d], graph, overview );
}

$(function () {
	introBox();
	addHelp();
});
</script>

</BODY>

</HTML>